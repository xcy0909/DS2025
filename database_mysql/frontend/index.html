<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <title>学生成绩管理系统</title>
    <!-- 引入Bootstrap（样式美化） -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- 引入ECharts（数据可视化） -->
    <script src="https://cdn.jsdelivr.net/npm/echarts@5.4.3/dist/echarts.min.js"></script>
    <style>
        .container { margin-top: 30px; }
        .tab-content { margin-top: 20px; }
        .chart-container {
            height: 500px;  /* 增加高度以容纳更多数据 */
            width: 700%;
            margin-bottom: 20px;
        }
        /* 调整图表容器，使其在移动端也能正常显示 */
        @media (max-width: 768px) {
            .chart-container {
                height: 400px;
            }
        }
        /* 添加滚动条样式 */
        .scrollable-chart {
            overflow-x: auto;
            padding-bottom: 10px;
        }
        .scrollable-chart > div {
            min-width: 800px;  /* 确保图表有足够的最小宽度 */
        }
    </style>
</head>
<body>
<div class="container">
    <h1 class="text-center mb-4">学生成绩管理系统</h1>

    <!-- 新增：用户信息和登出按钮 -->
    <div class="d-flex justify-content-end mb-3">
        <span id="user-info" class="me-3"></span>
        <button id="logout-btn" class="btn btn-outline-danger">登出</button>
    </div>

    <!-- 标签页切换 -->
    <ul class="nav nav-tabs" id="myTab" role="tablist">
        <li class="nav-item" role="presentation">
            <button class="nav-link active" id="student-tab" data-bs-toggle="tab" data-bs-target="#student" type="button" role="tab">学生管理</button>
        </li>
        <!-- 新增：成绩管理标签页 -->
        <li class="nav-item" role="presentation">
            <button class="nav-link" id="score-tab" data-bs-toggle="tab" data-bs-target="#score" type="button" role="tab">成绩管理</button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link" id="score-stat-tab" data-bs-toggle="tab" data-bs-target="#score-stat" type="button" role="tab">成绩统计</button>
        </li>

        <!-- 新增：复杂查询结果标签页 -->
        <li class="nav-item" role="presentation">
            <button class="nav-link" id="complex-query-tab" data-bs-toggle="tab" data-bs-target="#complex-query" type="button" role="tab">各专业及年级成绩统计结果</button>
        </li>
    </ul>

    <!-- 学生管理标签页（CRUD操作） -->
    <div class="tab-content" id="myTabContent">
        <div class="tab-pane fade show active" id="student" role="tabpanel">
            <!-- 添加学生表单 -->
            <div class="card mb-4">
                <div class="card-header">添加学生</div>
                <div class="card-body">
                    <form id="add-student-form">
                        <div class="row g-3">
                            <div class="col-md-3">
                                <label class="form-label">姓名</label>
                                <input type="text" class="form-control" id="name" required>
                            </div>
                            <div class="col-md-3">
                                <label class="form-label">性别</label>
                                <select class="form-select" id="gender" required>
                                    <option value="男">男</option>
                                    <option value="女">女</option>
                                </select>
                            </div>
                            <div class="col-md-3">
                                <label class="form-label">年级</label>
                                <input type="text" class="form-control" id="grade" required placeholder="如2023级">
                            </div>
                            <div class="col-md-3">
                                <label class="form-label">专业</label>
                                <input type="text" class="form-control" id="major" required>
                            </div>
                            <div class="col-12">
                                <button type="submit" class="btn btn-primary">添加</button>
                            </div>
                        </div>
                    </form>
                </div>
            </div>

            <!-- 学生列表 -->
            <div class="card">
                <div class="card-header">学生列表</div>
                <div class="card-body">
                    <table class="table table-striped">
                        <thead>
                            <tr>
                                <th>学生ID</th>
                                <th>姓名</th>
                                <th>性别</th>
                                <th>年级</th>
                                <th>专业</th>
                                <th>操作</th>
                            </tr>
                        </thead>
                        <tbody id="student-list"></tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- 新增：成绩管理标签页内容 -->
        <div class="tab-pane fade" id="score" role="tabpanel">
            <!-- 添加成绩表单 -->
            <div class="card mb-4">
                <div class="card-header">添加学生成绩</div>
                <div class="card-body">
                    <form id="add-score-form">
                        <div class="row g-3">
                            <div class="col-md-3">
                                <label class="form-label">学生ID</label>
                                <input type="number" class="form-control" id="score-student-id" required placeholder="输入学生ID">
                            </div>
                            <div class="col-md-3">
                                <label class="form-label">课程名称</label>
                                <input type="text" class="form-control" id="score-course" required placeholder="如：数据库原理">
                            </div>
                            <div class="col-md-3">
                                <label class="form-label">成绩</label>
                                <input type="number" class="form-control" id="score-value" required min="0" max="100" placeholder="0-100">
                            </div>
                            <div class="col-md-3">
                                <label class="form-label">考试日期</label>
                                <input type="date" class="form-control" id="score-exam-time" required>
                            </div>
                            <div class="col-12">
                                <button type="submit" class="btn btn-primary">添加成绩</button>
                            </div>
                        </div>
                    </form>
                </div>
            </div>

            <!-- 成绩列表 -->
            <div class="card">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <span>成绩列表</span>
                    <div class="input-group w-25">
                        <input type="number" class="form-control" id="filter-student-id" placeholder="按学生ID筛选">
                        <button class="btn btn-outline-secondary" onclick="filterScores()">查询</button>
                    </div>
                </div>
                <div class="card-body">
                    <table class="table table-striped">
                        <thead>
                            <tr>
                                <th>成绩ID</th>
                                <th>学生ID</th>
                                <th>学生姓名</th>
                                <th>课程</th>
                                <th>成绩</th>
                                <th>考试日期</th>
                                <th>操作</th>
                            </tr>
                        </thead>
                        <tbody id="score-list"></tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- 成绩统计标签页（包含表格和可视化图表） -->
        <div class="tab-pane fade" id="score-stat" role="tabpanel">
            <!-- 柱状图可视化 -->
            <div class="card mb-4">
                <div class="card-header">各专业课程平均成绩对比（可视化）</div>
                <div class="card-body scrollable-chart">
                    <div id="score-chart" class="chart-container"></div>
                </div>
                <div class="card-footer text-muted small">
                    <span>提示：可以拖动下方滑块或使用鼠标滚轮缩放查看所有数据</span>
                </div>
            </div>

            <!-- 统计表格 -->
            <div class="card">
                <div class="card-header">各专业课程成绩统计（表格）</div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-striped">
                            <thead>
                                <tr>
                                    <th>专业</th>
                                    <th>课程</th>
                                    <th>平均成绩</th>
                                    <th>最高分</th>
                                    <th>最低分</th>
                                    <th>参与人数</th>
                                </tr>
                            </thead>
                            <tbody id="score-stat-list"></tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

        <!-- 数据可视化标签页（保留原有标签页，但不再使用） -->
        <div class="tab-pane fade" id="visual" role="tabpanel">
            <div class="card">
                <div class="card-header">成绩分布可视化</div>
                <div class="card-body">
                    <div id="chart-container" class="chart-container"></div>
                </div>
            </div>
        </div>

        <!-- 新增：复杂查询结果标签页 -->
        <div class="tab-pane fade" id="complex-query" role="tabpanel">
            <div class="card mb-4">
                <div class="card-header">各专业课程成绩统计</div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-striped">
                            <thead>
                                <tr>
                                    <th>专业</th>
                                    <th>课程</th>
                                    <th>平均成绩</th>
                                    <th>最高分</th>
                                    <th>最低分</th>
                                    <th>参与人数</th>
                                </tr>
                            </thead>
                            <tbody id="score-stat-result"></tbody>
                        </table>
                    </div>
                </div>
            </div>

            <div class="card">
                <div class="card-header">各年级课程及格率统计</div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-striped">
                            <thead>
                                <tr>
                                    <th>年级</th>
                                    <th>课程</th>
                                    <th>总人数</th>
                                    <th>及格人数</th>
                                    <th>及格率(%)</th>
                                </tr>
                            </thead>
                            <tbody id="pass-rate-result"></tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- 引入Bootstrap和jQuery（交互逻辑） -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/jquery@3.6.4/dist/jquery.min.js"></script>
<script>
    // 后端接口基础地址
    const BASE_URL = "http://127.0.0.1:5000/api";

    // ---------------------- 登录状态管理 ----------------------
    // 页面加载时验证登录状态
    $(document).ready(function() {
        // 检查会话是否存在（前端辅助校验，核心校验在后端）
        $.get(`${BASE_URL}/students`, function(res) {
            if (res.code === 403) {
                // 未登录，跳转到登录页
                window.location.href = "/login";
            }
        }).fail(function() {
            window.location.href = "/login";
        });

        // 展示当前登录用户
        const username = localStorage.getItem('username') || '未知用户';
        $("#user-info").text(`当前登录：${username}`);

        // 登出按钮点击事件
        $("#logout-btn").click(function() {
            if (confirm("确定要登出吗？")) {
                $.ajax({
                    url: `${BASE_URL}/logout`,
                    type: "POST",
                    success: function(res) {
                        if (res.code === 200) {
                            localStorage.removeItem('username');
                            window.location.href = "/login";
                        }
                    }
                });
            }
        });

        // 加载核心数据
        loadStudents();
        loadScoreStat();
        initScoreChart();  // 初始化成绩统计图表
        loadScores();  // 新增：加载成绩列表
        loadComplexQueries();  // 新增：加载复杂查询结果
    });

    // ---------------------- 学生管理CRUD交互 ----------------------
    // 加载学生列表
    function loadStudents() {
        $.get(`${BASE_URL}/students`, function(res) {
            if (res.code === 200) {
                let html = "";
                res.data.forEach(student => {
                    html += `
                    <tr>
                        <td>${student.student_id}</td>
                        <td>${student.name}</td>
                        <td>${student.gender}</td>
                        <td>${student.grade}</td>
                        <td>${student.major}</td>
                        <td>
                            <button class="btn btn-sm btn-warning" onclick="editStudent(${student.student_id})">编辑</button>
                            <button class="btn btn-sm btn-danger" onclick="deleteStudent(${student.student_id})">删除</button>
                        </td>
                    </tr>
                    `;
                });
                $("#student-list").html(html);
            }
        });
    }

    // 添加学生 —— 修正 415 错误：使用 $.ajax 显式设置 contentType
    $("#add-student-form").submit(function(e) {
        e.preventDefault();
        const data = {
            name: $("#name").val(),
            gender: $("#gender").val(),
            grade: $("#grade").val(),
            major: $("#major").val()
        };
        $.ajax({
            url: `${BASE_URL}/students`,
            type: "POST",
            contentType: "application/json",
            data: JSON.stringify(data),
            success: function(res) {
                alert(res.msg);
                if (res.code === 200) {
                    $("#add-student-form")[0].reset();
                    loadStudents();
                }
            },
            error: function(xhr) {
                const res = xhr.responseJSON || { msg: "请求失败" };
                alert(res.msg);
            }
        });
    });

    // 删除学生
    function deleteStudent(studentId) {
        if (confirm("确定要删除该学生吗？")) {
            $.ajax({
                url: `${BASE_URL}/students/${studentId}`,
                type: "DELETE",
                success: function(res) {
                    alert(res.msg);
                    loadStudents();
                }
            });
        }
    }

    // 编辑学生（简化版：弹出输入框修改姓名和专业）
    function editStudent(studentId) {
        const newName = prompt("请输入新姓名");
        const newMajor = prompt("请输入新专业");
        if (newName && newMajor) {
            $.ajax({
                url: `${BASE_URL}/students/${studentId}`,
                type: "PUT",
                data: JSON.stringify({ name: newName, major: newMajor }),
                contentType: "application/json",
                success: function(res) {
                    alert(res.msg);
                    loadStudents();
                }
            });
        }
    }

    // ---------------------- 成绩管理CRUD交互 ----------------------
    // 加载成绩列表
    function loadScores(studentId = '') {
        let url = `${BASE_URL}/scores`;
        if (studentId) url += `?student_id=${studentId}`;
        $.get(url, function(res) {
            if (res.code === 200) {
                let html = "";
                res.data.forEach(score => {
                    html += `
                    <tr>
                        <td>${score.score_id}</td>
                        <td>${score.student_id}</td>
                        <td>${score.student_name}</td>
                        <td>${score.course}</td>
                        <td>${score.score}</td>
                        <td>${score.exam_time}</td>
                        <td>
                            <button class="btn btn-sm btn-warning" onclick="editScore(${score.score_id})">编辑</button>
                            <button class="btn btn-sm btn-danger" onclick="deleteScore(${score.score_id})">删除</button>
                        </td>
                    </tr>
                    `;
                });
                $("#score-list").html(html);
            }
        });
    }

    // 添加成绩 —— 修正 415 错误：使用 $.ajax 显式设置 contentType
    $("#add-score-form").submit(function(e) {
        e.preventDefault();
        const data = {
            student_id: $("#score-student-id").val(),
            course: $("#score-course").val(),
            score: $("#score-value").val(),
            exam_time: $("#score-exam-time").val()
        };
        $.ajax({
            url: `${BASE_URL}/scores`,
            type: "POST",
            contentType: "application/json",
            data: JSON.stringify(data),
            success: function(res) {
                alert(res.msg);
                if (res.code === 200) {
                    $("#add-score-form")[0].reset();
                    loadScores();
                }
            },
            error: function(xhr) {
                const res = xhr.responseJSON || { msg: "请求失败" };
                alert(res.msg);
            }
        });
    });

    // 筛选成绩
    function filterScores() {
        const studentId = $("#filter-student-id").val().trim();
        loadScores(studentId);
    }

    // 编辑成绩
    function editScore(scoreId) {
        const newCourse = prompt("请输入新课程名称");
        const newScore = prompt("请输入新成绩（0-100）");
        if (newCourse && newScore && !isNaN(newScore) && newScore >=0 && newScore <=100) {
            $.ajax({
                url: `${BASE_URL}/scores/${scoreId}`,
                type: "PUT",
                data: JSON.stringify({ course: newCourse, score: newScore }),
                contentType: "application/json",
                success: function(res) {
                    alert(res.msg);
                    loadScores();
                }
            });
        } else {
            alert("输入参数无效");
        }
    }

    // 删除成绩
    function deleteScore(scoreId) {
        if (confirm("确定要删除该成绩吗？")) {
            $.ajax({
                url: `${BASE_URL}/scores/${scoreId}`,
                type: "DELETE",
                success: function(res) {
                    alert(res.msg);
                    loadScores();
                }
            });
        }
    }

    // ---------------------- 成绩统计加载 ----------------------
    function loadScoreStat() {
        $.get(`${BASE_URL}/complex/score-stat`, function(res) {
            if (res.code === 200) {
                // 更新表格数据
                let html = "";
                res.data.forEach(item => {
                    html += `
                    <tr>
                        <td>${item.major}</td>
                        <td>${item.course}</td>
                        <td>${item.avg_score}</td>
                        <td>${item.max_score}</td>
                        <td>${item.min_score}</td>
                        <td>${item.student_count}</td>
                    </tr>
                    `;
                });
                $("#score-stat-list").html(html);

                // 更新图表数据
                updateScoreChart(res.data);
            }
        });
    }

    // ---------------------- 复杂查询结果加载 ----------------------
    function loadComplexQueries() {
        // 加载成绩统计
        $.get(`${BASE_URL}/complex/score-stat`, function(res) {
            if (res.code === 200) {
                let html = "";
                res.data.forEach(item => {
                    html += `
                    <tr>
                        <td>${item.major}</td>
                        <td>${item.course}</td>
                        <td>${item.avg_score}</td>
                        <td>${item.max_score}</td>
                        <td>${item.min_score}</td>
                        <td>${item.student_count}</td>
                    </tr>
                    `;
                });
                $("#score-stat-result").html(html);
            }
        });

        // 加载及格率统计
        $.get(`${BASE_URL}/complex/pass-rate`, function(res) {
            if (res.code === 200) {
                let html = "";
                res.data.forEach(item => {
                    html += `
                    <tr>
                        <td>${item.grade}</td>
                        <td>${item.course}</td>
                        <td>${item.total_students}</td>
                        <td>${item.pass_students}</td>
                        <td>${item.pass_rate}</td>
                    </tr>
                    `;
                });
                $("#pass-rate-result").html(html);
            }
        });
    }

    // ---------------------- 成绩统计图表可视化 ----------------------
    let scoreChart;

    // 初始化成绩统计图表
    function initScoreChart() {
        scoreChart = echarts.init(document.getElementById('score-chart'));

        // 获取图表容器的宽度
        const chartContainer = document.getElementById('score-chart');
        const containerWidth = chartContainer.parentElement.clientWidth;

        // 根据数据数量动态调整柱状图宽度
        function calculateBarWidth(dataCount) {
            if (!dataCount || dataCount <= 0) return 40; // 默认宽度

            // 根据容器宽度和数据数量计算合适的柱宽
            const availableWidth = Math.max(containerWidth, 800); // 最小800px
            const maxBarsVisible = Math.floor(availableWidth / 60); // 每个柱约60px
            const barWidth = Math.max(20, Math.min(50, availableWidth / Math.max(dataCount, 10)));
            return barWidth;
        }

        // 初始配置
        const option = {
            title: {
                text: '各专业课程平均成绩对比',
                left: 'center',
                textStyle: {
                    fontSize: 18,
                    fontWeight: 'bold'
                }
            },
            tooltip: {
                trigger: 'axis',
                axisPointer: {
                    type: 'shadow'
                },
                formatter: function(params) {
                    const data = params[0];
                    return `${data.name}<br/>平均成绩: ${data.value}分`;
                }
            },
            legend: {
                data: ['平均成绩'],
                top: 30
            },
            grid: {
                left: '3%',
                right: '3%',
                bottom: '15%',  // 增加底部空间以显示更多标签
                top: '15%',
                containLabel: true
            },
            xAxis: {
                type: 'category',
                data: [],
                axisLabel: {
                    interval: 0,
                    rotate: 30,  // 减少旋转角度
                    fontSize: 12,
                    width: 80,   // 设置标签宽度
                    overflow: 'break'  // 标签过长时自动换行
                },
                axisTick: {
                    alignWithLabel: true
                }
            },
            yAxis: {
                type: 'value',
                name: '成绩（分）',
                min: 0,
                max: 100,
                axisLabel: {
                    formatter: '{value} 分'
                }
            },
            series: [{
                name: '平均成绩',
                type: 'bar',
                data: [],
                barWidth: calculateBarWidth(0), // 初始宽度
                barMaxWidth: 60, // 最大宽度
                itemStyle: {
                    color: function(params) {
                        // 根据成绩高低显示不同颜色
                        const score = params.value;
                        if (score >= 90) return '#52c41a';  // 优秀：绿色
                        if (score >= 80) return '#1890ff';  // 良好：蓝色
                        if (score >= 70) return '#faad14';  // 中等：黄色
                        if (score >= 60) return '#ff7a45';  // 及格：橙色
                        return '#f5222d';  // 不及格：红色
                    }
                },
                label: {
                    show: true,
                    position: 'top',
                    formatter: '{c}分',
                    fontSize: 11
                },
                emphasis: {
                    itemStyle: {
                        shadowBlur: 10,
                        shadowOffsetX: 0,
                        shadowColor: 'rgba(0, 0, 0, 0.5)'
                    }
                }
            }],
            dataZoom: [
                {
                    type: 'slider',
                    show: true,
                    xAxisIndex: [0],
                    start: 0,
                    end: 100,
                    bottom: '5%',  // 调整滑块位置
                    height: 20
                },
                {
                    type: 'inside',
                    xAxisIndex: [0],
                    start: 0,
                    end: 100
                }
            ]
        };

        scoreChart.setOption(option);

        // 窗口大小变化时自适应图表
        window.addEventListener('resize', function() {
            scoreChart.resize();
        });
    }

    // 更新成绩统计图表数据
    function updateScoreChart(statData) {
        if (!statData || statData.length === 0) {
            // 没有数据时显示提示
            scoreChart.setOption({
                title: {
                    text: '各专业课程平均成绩对比\n（暂无数据）',
                    subtext: '请先添加学生成绩数据',
                    left: 'center',
                    top: 'center'
                },
                xAxis: { data: [] },
                series: [{ data: [] }]
            });
            return;
        }

        // 生成图表数据
        const xData = [];
        const yData = [];

        statData.forEach(item => {
            // 使用换行符分隔专业和课程
            xData.push(`${item.major}\n${item.course}`);
            yData.push(parseFloat(item.avg_score).toFixed(1));
        });

        // 动态计算柱状图宽度
        const barWidth = Math.max(20, Math.min(50, 800 / xData.length));

        const option = {
            xAxis: {
                data: xData,
                axisLabel: {
                    rotate: xData.length > 10 ? 45 : 0  // 数据多时旋转标签
                }
            },
            series: [{
                name: '平均成绩',
                data: yData,
                barWidth: barWidth
            }]
        };

        scoreChart.setOption(option);
    }

    // ---------------------- 原有的数据可视化函数（保留但不再使用） ----------------------
    let myChart;
    function initChart() {
        myChart = echarts.init(document.getElementById('chart-container'));
        // 初始配置
        const option = {
            title: { text: '各专业课程平均成绩对比' },
            tooltip: {},
            legend: { data: ['平均成绩'] },
            xAxis: { data: [] },
            yAxis: {},
            series: [{
                name: '平均成绩',
                type: 'bar',
                data: []
            }]
        };
        myChart.setOption(option);
    }

    // 更新图表数据
    function updateChart(statData) {
        const xData = statData.map(item => `${item.major}-${item.course}`);
        const yData = statData.map(item => item.avg_score);
        const option = {
            xAxis: { data: xData },
            series: [{ data: yData }]
        };
        myChart.setOption(option);
    }
</script>
</body>
</html>